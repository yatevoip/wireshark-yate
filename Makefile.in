# Makefile
# This file holds the make rules for the Wireshark-Yate Plugin

DESTDIR := 

CC  := @CC@ -Wall
INCLUDES := -I. -I@srcdir@
CFLAGS :=  @WIRESHARKDEVEL_INC@ @GLIBDEVEL_INC@ 
INCFILES :=

MKDEPS := ./config.status
PROGS=wireshark-yate
OBJS = plugin.o packet-yimp.o
LIB = yimp.so
LIBS = @WIRESHARKDEVEL_LIB@ @GLIBDEVEL_LIB@ 

COMPILE = $(CC) $(INCLUDES) $(CFLAGS)
LINK = $(CC) $(LDFLAGS) $(LIBS)

moddir := @WIRESHARKDIR@

$(LIB): CFLAGS += -fPIC
$(LIB): LDFLAGS += -shared
$(LIB): $(OBJS)
	$(CC) $(LDFLAGS) $^ $(LIBS) -o $@

%.o: @srcdir@/%.c $(MKDEPS) $(INCFILES)
	$(COMPILE) -c $< 
	
lib%.so:%.o
	$(LINK) -shared -o $@ $^ $(LIBS)
 
Makefile: @srcdir@/Makefile.in config.status
	./config.status

.PHONY: install	
install:
	@mkdir -p "$(DESTDIR)$(moddir)/" && \
	for i in $(LIB) ; do \
	    install -m 644 yimp.so $(DESTDIR)$(moddir)/ ; \
	done; \
	
.PHONY: uninstall
uninstall:
	@-for i in $(LIB) ; do \
	    rm -f "$(DESTDIR)$(moddir)/$$i" ; \
	done; 
	@-rmdir "$(DESTDIR)$(moddir)"

.PHONY: snapshot tarball rpm
snapshot tarball: 
	@if [ $@ = snapshot ]; then ver="`date '+CVS-%Y%m%d'`"; else ver="@PACKAGE_VERSION@"; fi ; \
	wd=`pwd|sed 's,^.*/,,'`; \
	mkdir -p tarballs; cd ..; \
	echo $$wd/tar-exclude >$$wd/tar-exclude; \
	find $$wd -name Makefile >>$$wd/tar-exclude; \
	if [ $@ = tarball ]; then \
	    find $$wd -name CVS >>$$wd/tar-exclude; \
	    find $$wd -name .cvsignore >>$$wd/tar-exclude; \
	else \
	    find $$wd -name '*.spec' >>$$wd/tar-exclude; \
	fi ; \
	tar czf $$wd/tarballs/$$wd-$$ver.tar.gz \
	--exclude $$wd/tarballs \
	--exclude $$wd/config.status \
	--exclude $$wd/config.log \
	-X $$wd/tar-exclude \
	$$wd; \
	rm $$wd/tar-exclude
	
rpm: tarball
	rpmbuild -tb tarballs/@PACKAGE_TARNAME@-@PACKAGE_VERSION@.tar.gz
	
.PHONY: clean
clean:
	@-$(RM) $(CLEANS) 2>/dev/null
	
